<!-- Launcher (only for standalone testing, hidden in iframe) -->
<button
  class="lexi-launcher"
  (click)="toggle()"
  [class.active]="open()"
  aria-label="Open chat"
>
  ✦
</button>

<!-- Chat Window -->
<div class="lexi-window" [class.open]="open()">
  <!-- <header class="lexi-header">
    <div class="lexi-title">
      <img src="assets/lexi-chat.png" alt="Lexi" class="lexi-logo" />
    </div>
    <button class="lexi-close" (click)="toggle()" aria-label="Close">✕</button>
  </header> -->

  <header class="lexi-header">
    <div class="lexi-title">
      <img src="assets/lexi-chat.png" alt="Lexi" class="lexi-logo" />
    </div>
    <!-- ✅ Changed from ✕ to "Collapse" with icon -->
    <button
      class="lexi-close"
      (click)="toggle()"
      aria-label="Collapse chat"
    ></button>
  </header>

  <section class="lexi-body" role="log" aria-live="polite" #log>
    <!-- CONNECTING OVERLAY -->
    <div class="lexi-connecting" *ngIf="connectionState() === 'connecting'">
      <div class="spinner"></div>
      <div class="msg">Connecting to Lexi…</div>
    </div>

    <!-- ERROR STATE -->
    <div class="lexi-connecting error" *ngIf="connectionState() === 'error'">
      <div class="msg">Connection failed. Please refresh.</div>
    </div>
    <!-- Day / time chip at top -->
    <div class="lexi-daystamp">{{ formatDaystamp() }}</div>
    <ng-container *ngFor="let m of messages(); let i = index">
      <div class="lexi-msg" [class.user]="m.role === 'user'">
        <div *ngIf="m.role !== 'user'" class="lexi-avatar">
          <img src="assets/lexi-logo.png" alt="Lexi" class="lexi-logo-only" />
        </div>
        <div class="lexi-col">
          <div class="lexi-meta">
            <span class="lexi-name">{{
              m.role === "user" ? "You" : assistantName
            }}</span>
            <span class="lexi-time">{{ formatTime(m, m.timestamp) }}</span>
          </div>
          <div class="lexi-bubble">{{ m.text }}</div>
          <!-- Suggestions right after the first (welcome) message -->
          <div *ngIf="i === 0 && showSuggestions()" class="lexi-suggestions">
            <button
              *ngFor="let option of activeSuggestions"
              class="lexi-chip"
              (click)="sendSuggestion(option)"
            >
              {{ option }}
            </button>
          </div>
        </div>
      </div>
    </ng-container>
    <div class="lexi-ended" *ngIf="ended()">
      <p>Lexi has left the chat. Please refresh page to continue.</p>
    </div>
    <div *ngIf="sending()" class="lexi-typing" aria-label="Lexi is typing">
      <span class="dot"></span><span class="dot"></span
      ><span class="dot"></span>
    </div>
  </section>

  <footer class="lexi-input">
    <div class="input-wrapper">
      <textarea
        #input
        placeholder="Type here..."
        [disabled]="sending() || connectionState() !== 'connected' || ended()"
        (keydown)="keydown($event)"
        [ngModel]="text()"
        (ngModelChange)="text.set($event)"
      ></textarea>
      <button
        class="lexi-send"
        [disabled]="sending() || connectionState() !== 'connected' || ended()"
        (click)="send()"
        aria-label="Send"
      >
        <!-- ➤ -->
        <!-- Modern send icon -->
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          viewBox="0 0 24 24"
          width="22"
          height="22"
        >
          <line x1="22" y1="2" x2="11" y2="13" />
          <polygon points="22 2 15 22 11 13 2 9 22 2" />
        </svg>
      </button>
    </div>
  </footer>
</div>
